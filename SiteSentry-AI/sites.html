<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Websites - SiteSentry AI</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-50">
    <custom-navbar></custom-navbar>

    <div class="pt-16"> <custom-sidebar></custom-sidebar>

        <div class="ml-20 md:ml-72"> <main class="flex-1 p-8"> <div class="mb-8 flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">My Websites</h1>
                        <p class="text-gray-600">Manage your connected websites</p>
                    </div>
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6 rounded-lg">
                        <div class="flex items-center justify-between">
                            <p class="font-medium text-blue-800">
                                To connect your site, first download and install our connector plugin.
                            </p>
                            <a href="/sitesentry-connector.zip" download class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-2 px-4 rounded-lg flex items-center">
                                <i data-feather="download" class="w-4 h-4 mr-2"></i>
                                Download Connector (.zip)
                            </a>
                        </div>
                        <p class="text-sm text-blue-700 mt-2">
                            1. Install the downloaded ZIP file in your WordPress dashboard.<br>
                            2. Activate the plugin and copy the generated API Key for the form below.
                        </p>
                    </div>
                    <button id="add-site-btn" class="bg-primary border border-gray-300 hover:bg-blue-600 text-black font-bold py-2 px-4 rounded-lg flex items-center">
                        <i data-feather="plus" class="w-5 h-5 mr-2"></i>
                        Add New Website
                    </button>
                </div>

                <div id="add-site-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden flex items-center justify-center">
                    <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Add a New Website</h3>
                            <button id="close-modal-btn"><i data-feather="x"></i></button>
                        </div>
                        <form id="add-site-form" class="space-y-4">
                            <div>
                                <label for="site-url" class="block text-sm font-medium text-gray-700">Website URL</label>
                                <input type="url" id="site-url" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="https://example.com" required>
                            </div>
                            <div>
                                <label for="connector-url" class="block text-sm font-medium text-gray-700">Connector Plugin URL</label>
                                <input type="url" id="connector-url" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="https://example.com/wp-json/sitesentry/v1" required>
                                <p class="text-xs text-gray-500 mt-1">Found in your SiteSentry Connector plugin settings.</p>
                            </div>
                            <div>
                                <label for="api-key" class="block text-sm font-medium text-gray-700">Connector API Key</label>
                                <input type="text" id="api-key" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Your secret key from the plugin" required>
                            </div>
                            <div id="modal-message-area" class="text-sm"></div>
                            <button type="submit" class="w-full bg-primary border border-gray-300 hover:bg-blue-600 text-black text-center font-bold py-2 px-4 rounded-lg">
                                Add Website
                            </button>
                        </form>
                    </div>
                </div>

                <div id="site-list" class="bg-white p-6 rounded-xl shadow-sm">
                    <p class="text-gray-500">Loading websites...</p>
                    </div>
            </main>

            <custom-footer></custom-footer>

        </div> </div> <script src="components/navbar.js"></script>
    <script src="components/sidebar.js"></script>
    <script src="components/footer.js"></script>
    <script>
        // --- Run Feather Icons AFTER the DOM is loaded ---
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace(); // Initial replace for static icons

            const addSiteBtn = document.getElementById('add-site-btn');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const addSiteModal = document.getElementById('add-site-modal');
            const addSiteForm = document.getElementById('add-site-form');
            const siteListDiv = document.getElementById('site-list');
            const messageArea = document.getElementById('modal-message-area');

            // --- Modal Controls ---
            if(addSiteBtn) { // Check if button exists before adding listener
                addSiteBtn.addEventListener('click', () => {
                    if(addSiteModal) addSiteModal.classList.remove('hidden');
                    if(messageArea) messageArea.textContent = ''; // Clear previous messages
                    if(addSiteForm) addSiteForm.reset(); // Clear the form
                });
            }
            if(closeModalBtn) {
                closeModalBtn.addEventListener('click', () => {
                   if(addSiteModal) addSiteModal.classList.add('hidden');
                });
            }
            // Close modal if clicking outside the form area
            if(addSiteModal) {
                addSiteModal.addEventListener('click', (event) => {
                    if (event.target === addSiteModal) {
                        addSiteModal.classList.add('hidden');
                    }
                });
            }

            // --- Authentication Check ---
            const token = localStorage.getItem('siteSentryToken');
            if (!token) {
                // Redirect to login if no token found
                window.location.href = '/login.html';
                return; // Stop further execution if not logged in
            }

            // --- Handle Add Site Form Submission ---
            if (addSiteForm) {
                addSiteForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if(messageArea) {
                        messageArea.textContent = 'Adding website...';
                        messageArea.style.color = 'gray';
                    }

                    const siteUrl = document.getElementById('site-url').value;
                    const connectorUrl = document.getElementById('connector-url').value;
                    const apiKey = document.getElementById('api-key').value;

                    try {
                        const response = await axios.post('/api/websites', { // Use relative path
                            url: siteUrl,
                            connectorUrl: connectorUrl,
                            apiKey: apiKey
                        }, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        if(messageArea) {
                            messageArea.textContent = 'Website added successfully!';
                            messageArea.style.color = 'green';
                        }

                        setTimeout(() => {
                            if(addSiteModal) addSiteModal.classList.add('hidden');
                            loadSites(); // Reload the list after adding
                        }, 1500);

                    } catch (err) {
                        console.error('Error adding website:', err);
                        if(messageArea) {
                            messageArea.textContent = err.response?.data?.error || 'Failed to add site. Check details or server connection.';
                            messageArea.style.color = 'red';
                        }
                    }
                });
            }

            // --- Function to load and display sites ---
            async function loadSites() {
                if (!siteListDiv) return; // Make sure the div exists
                siteListDiv.innerHTML = '<p class="text-gray-500">Loading websites...</p>'; // Show loading state
                try {
                    const response = await axios.get('/api/websites', { // Use relative path
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const sites = response.data;
                    if (!sites || sites.length === 0) {
                        siteListDiv.innerHTML = '<p class="text-gray-500">No websites added yet. Click "Add New Website" above to get started.</p>';
                    } else {
                        siteListDiv.innerHTML = `
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Website URL</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Added On</th>
                                            <th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${sites.map(site => `
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="text-sm font-medium text-gray-900">${site.url}</div>
                                                    <div class="text-sm text-gray-500">${site.connectorUrl}</div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${site.status === 'UP' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                                        ${site.status || 'Checking...'}
                                                    </span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    ${new Date(site.createdAt).toLocaleDateString()}
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                    <button onclick="deleteSite('${site._id}')" class="text-red-600 hover:text-red-900 ml-4"><i data-feather="trash-2" class="w-4 h-4 inline"></i> Delete</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                        feather.replace(); // Re-render icons AFTER adding them to the DOM
                    }

                } catch (err) {
                    console.error('Error loading websites:', err);
                    if(siteListDiv) siteListDiv.innerHTML = '<p class="text-red-500">Error loading websites. Please try again later.</p>';
                    if (err.response && (err.response.status === 401 || err.response.status === 403)) {
                        localStorage.removeItem('siteSentryToken');
                        window.location.href = '/login.html';
                    }
                }
            }

            // --- Make deleteSite global or attach listener differently ---
            window.deleteSite = async function(siteId) {
                if (!confirm('Are you sure you want to delete this website connection? This cannot be undone.')) {
                    return;
                }
                try {
                    await axios.delete(`/api/websites/${siteId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    loadSites(); // Reload list after deleting
                } catch (err) {
                    console.error('Error deleting website:', err);
                    alert('Failed to delete website. Please try again.');
                    if (err.response && (err.response.status === 401 || err.response.status === 403)) {
                        localStorage.removeItem('siteSentryToken');
                        window.location.href = '/login.html';
                    }
                }
            }

            // --- Initial Load ---
            loadSites(); // Load sites once the DOM is ready and auth is checked

        }); // End DOMContentLoaded listener
    </script>
</body>
</html>